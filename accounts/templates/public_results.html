{% extends "base.html" %}
{% block title %}Kalolsavam 2026 | Official Results{% endblock %}
{% load static %}

{% block content %}
<div class="results-container">

  <!-- HERO SECTION -->
  <section class="hero-section">
    <div class="container-fluid px-3 px-md-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div class="hero-content">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="hero-icon">üèÜ</span>
            <h1 class="hero-title mb-0">Kannur University Union Kalolsavam 2026</h1>
          </div>
          <p class="hero-subtitle mb-0">Live Results & Scoreboard</p>
        </div>
        <div class="hero-controls">
          <div class="d-flex flex-column flex-sm-row align-items-end align-items-sm-center gap-2">
            
            <div class="text-light text-end">
              <small class="update-time">Updated: {% now "F j, Y ¬∑ g:i a" %}</small>
              <div class="live-badge d-inline-flex align-items-center ms-2">
                <span class="live-dot"></span>
                <small class="ms-1">LIVE</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <main class="container-fluid px-3 px-md-4 py-4">
    <div class="row g-4">
      
      <!-- LEFT COLUMN: MAIN CONTENT -->
      <div class="col-xxl-9 col-lg-8">
        
        <!-- OVERALL LEADERBOARD -->
        <section class="card-section mb-4">
          <div class="card main-card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">Overall College Leaderboard</h2>
                <span class="badge rank-badge">Top {{ overall_colleges|length }}</span>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive-xxl">
                <table class="table table-leaderboard mb-0">
                  <thead>
                    <tr>
                      <th width="60">Rank</th>
                      <th>College</th>
                      <th class="text-end" width="120">Total Points</th>
                    </tr>
                  </thead>
                  <tbody id="overall-body">
                    {% for c in overall_colleges %}
                    <tr class="{% if forloop.counter <= 3 %}highlight-row{% endif %}">
                      <td>
                        <div class="rank-cell {% if forloop.counter == 1 %}rank-gold{% elif forloop.counter == 2 %}rank-silver{% elif forloop.counter == 3 %}rank-bronze{% endif %}">
                          {{ forloop.counter }}
                        </div>
                      </td>
                      <td>
                        <div class="college-info">
                          <div class="college-name">{{ c.team__college__college_name }}</div>
                        </div>
                      </td>
                      <td class="text-end">
                        <span class="points-display">{{ c.total_points }}</span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- SEARCH AND FILTER -->
        <section class="card-section mb-4">
          <div class="card filter-card">
            <div class="card-body p-3 p-md-4">
              <form method="get" class="row g-2 g-md-3">
                <div class="col-md-5">
                  <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                      <i class="bi bi-search"></i>
                    </span>
                    <input type="text" name="q" value="{{ q }}" class="form-control border-start-0"
                           placeholder="Search item, category, college or student...">
                  </div>
                </div>
                <div class="col-md-4">
                  <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    {% for c in categories %}
                    <option value="{{ c }}" {% if c == selected_category %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-3">
                  <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel me-1"></i>Filter
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- FULL RESULTS TABLE -->
        <section class="card-section">
          <div class="card main-card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">Complete Result List</h2>
                <small class="text-muted">{{ full_results|length }} results</small>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive-xxl">
                <table class="table table-results mb-0">
                  <thead>
                    <tr>
                      <th width="180">Item</th>
                      <th width="120">Category</th>
                      <th>College</th>
                      <th width="150">Participants</th>
                      <th width="100">Position</th>
                      <th width="80">Grade</th>
                      <th class="text-end" width="100">Points</th>
                    </tr>
                  </thead>
                  <tbody id="full-results-body">
                    {% for r in full_results %}
                    <tr>
                      <td>
                        <div class="item-name">{{ r.item.name }}</div>
                      </td>
                      <td>
                        <span class="category-badge">{{ r.item.category }}</span>
                      </td>
                      <td>
                        <div class="college-name-sm">{{ r.team.college.college_name }}</div>
                      </td>
                      <td>
                        <div class="students-list">
                          {% for s in r.team.students.all %}
                          <span class="student-name">{{ s.name }}</span>{% if not forloop.last %}, {% endif %}
                          {% endfor %}
                        </div>
                      </td>
                      <td>
                        <span class="position-badge position-{{ r.position }}">
                          {{ r.get_position_display }}
                        </span>
                      </td>
                      <td>
                        <span class="grade-badge">{{ r.grade }}</span>
                      </td>
                      <td class="text-end">
                        <span class="points-display">{{ r.points }}</span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if full_results|length == 0 %}
              <div class="empty-state text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
                <p class="text-muted">No results found. Try adjusting your filters.</p>
              </div>
              {% endif %}
            </div>
          </div>
        </section>
      </div>

      <!-- RIGHT COLUMN: SIDEBAR -->
      <div class="col-xxl-3 col-lg-4">
        
        <!-- TOP PERFORMERS -->
        <section class="card-section sticky-sidebar">
          <div class="card sidebar-card">
            <div class="card-header">
              <h2 class="card-title mb-0">Top Individual Performers</h2>
            </div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush" id="individual-body">
                {% for s in individual_top %}
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="performer-info">
                      <div class="performer-name">{{ s.team__students__name }}</div>
                      <div class="performer-college">{{ s.team__college__college_name }}</div>
                    </div>
                    <div class="performer-points">
                      <span class="points-badge">{{ s.total_points }}</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </section>

        <!-- UPDATE INFO -->
        <div class="update-card mt-3">
          <div class="d-flex align-items-center text-muted">
            <i class="bi bi-info-circle me-2"></i>
            <small>Page auto-updates every 20 seconds</small>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- LIVE UPDATE SCRIPT -->
<script>
class ResultsUpdater {
  constructor() {
    this.isUpdating = false;
    this.init();
  }

  init() {
    // Auto-refresh every 20 seconds
    setInterval(() => this.refreshResults(), 20000);
    
    // Add pull-to-refresh on mobile
    let touchStartY = 0;
    document.addEventListener('touchstart', e => {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchend', e => {
      const touchEndY = e.changedTouches[0].clientY;
      const diff = touchStartY - touchEndY;
      
      if (diff > 100 && window.scrollY === 0) {
        this.refreshResults();
      }
    }, { passive: true });
  }

  async refreshResults() {
    if (this.isUpdating) return;
    
    this.isUpdating = true;
    const updateIndicator = document.querySelector('.live-dot');
    if (updateIndicator) updateIndicator.classList.add('pulsing');
    
    try {
      const response = await fetch(window.location.href, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        cache: 'no-store'
      });
      
      if (!response.ok) throw new Error('Network error');
      
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Update each section with animation
      await this.updateSection('overall-body', doc);
      await this.updateSection('individual-body', doc);
      await this.updateSection('full-results-body', doc);
      
      // Update timestamp
      const timestamp = doc.querySelector('.update-time');
      if (timestamp) {
        document.querySelector('.update-time').innerHTML = timestamp.innerHTML;
      }
      
      this.showToast('Results updated successfully');
    } catch (error) {
      console.error('Update failed:', error);
      this.showToast('Update failed. Please refresh page.', 'error');
    } finally {
      this.isUpdating = false;
      if (updateIndicator) updateIndicator.classList.remove('pulsing');
    }
  }

  async updateSection(sectionId, newDoc) {
    const newContent = newDoc.getElementById(sectionId);
    const currentElement = document.getElementById(sectionId);
    
    if (newContent && currentElement) {
      // Add update animation
      currentElement.style.opacity = '0.7';
      await this.sleep(300);
      currentElement.innerHTML = newContent.innerHTML;
      currentElement.style.opacity = '1';
      
      // Trigger animation for new rows
      const newRows = currentElement.querySelectorAll('tr, .list-group-item');
      newRows.forEach((row, index) => {
        row.style.animationDelay = `${index * 50}ms`;
        row.classList.add('fade-in');
      });
    }
  }

  showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `live-toast toast-${type}`;
    toast.innerHTML = `
      <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
      ${message}
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
  window.resultsUpdater = new ResultsUpdater();
});
</script>

<style>
/* Base Styles */
:root {
  --primary-color: #961f1f;
  --primary-dark: #7a1919;
  --secondary-color: #c9a13b;
  --light-bg: #f8f9fa;
  --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --card-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.results-container {
  min-height: 100vh;
  background: var(--light-bg);
}

/* Hero Section */
.hero-section {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
  color: white;
  padding: 1.5rem 0;
  position: relative;
  overflow: hidden;
}

.hero-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("{% static 'img/logo.png' %}") ;
}

.hero-icon {
  font-size: 2.5rem;
  line-height: 1;
}

.hero-title {
  font-size: clamp(1.5rem, 4vw, 2.2rem);
  font-weight: 800;
  line-height: 1.2;
}

.hero-subtitle {
  font-size: 1rem;
  opacity: 0.9;
}

.btn-back {
  border-width: 2px;
  font-weight: 500;
  transition: all 0.2s;
}

.btn-back:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateX(-2px);
}

.live-badge {
  font-size: 0.75rem;
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 8px;
  border-radius: 12px;
}

.live-dot {
  width: 6px;
  height: 6px;
  background: #4ade80;
  border-radius: 50%;
  display: inline-block;
  animation: pulse 2s infinite;
}

.live-dot.pulsing {
  animation: pulse-fast 0.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes pulse-fast {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* Cards */
.main-card, .sidebar-card, .filter-card {
  border: none;
  border-radius: 16px;
  box-shadow: var(--card-shadow);
  transition: transform 0.2s, box-shadow 0.2s;
  overflow: hidden;
}

.main-card:hover, .sidebar-card:hover {
  box-shadow: var(--card-shadow-hover);
  transform: translateY(-2px);
}

.card-header {
  background: white;
  border-bottom: 2px solid var(--secondary-color);
  padding: 1.25rem 1.5rem;
}

.card-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary-dark);
}

/* Tables */
.table-leaderboard, .table-results {
  margin: 0;
}

.table-leaderboard thead th,
.table-results thead th {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
  padding: 1rem 1.5rem;
  color: #6c757d;
}

.table-leaderboard tbody td,
.table-results tbody td {
  padding: 1rem 1.5rem;
  vertical-align: middle;
  border-bottom: 1px solid #f0f0f0;
}

.rank-cell {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-weight: 700;
  font-size: 0.9rem;
  background: #f8f9fa;
  color: #6c757d;
}

.rank-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
.rank-silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; }
.rank-bronze { background: linear-gradient(135deg, #CD7F32, #A0522D); color: white; }

.highlight-row {
  background: linear-gradient(90deg, rgba(150, 31, 31, 0.03), transparent);
}

.college-name {
  font-weight: 600;
  color: #212529;
}

.college-name-sm {
  font-weight: 500;
  font-size: 0.95rem;
}

.points-display {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--primary-color);
}

/* Badges */
.category-badge {
  display: inline-block;
  padding: 4px 10px;
  background: #e9ecef;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 500;
  color: #495057;
}

.position-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.85rem;
  text-align: center;
  min-width: 70px;
}

.position-1 { background: #fff3cd; color: #856404; }
.position-2 { background: #d4edda; color: #155724; }
.position-3 { background: #d1ecf1; color: #0c5460; }

.grade-badge {
  display: inline-block;
  width: 36px;
  height: 36px;
  line-height: 36px;
  text-align: center;
  background: #f8f9fa;
  border-radius: 50%;
  font-weight: 700;
  color: var(--primary-color);
}

/* Top Performers */
.performer-info {
  flex: 1;
  min-width: 0;
}

.performer-name {
  font-weight: 600;
  color: #212529;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.performer-college {
  font-size: 0.85rem;
  color: #6c757d;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.points-badge {
  display: inline-block;
  padding: 6px 12px;
  background: var(--primary-color);
  color: white;
  border-radius: 8px;
  font-weight: 700;
  font-size: 0.95rem;
  min-width: 50px;
  text-align: center;
}

/* List Group */
.list-group-item {
  padding: 1.25rem 1.5rem;
  border-color: #f0f0f0;
  transition: background-color 0.2s;
}

.list-group-item:hover {
  background-color: #f8f9fa;
}

/* Sticky Sidebar */
.sticky-sidebar {
  position: sticky;
  top: 100px;
  z-index: 10;
}

/* Toast Notification */
.live-toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: white;
  color: #212529;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  z-index: 1050;
  display: flex;
  align-items: center;
  font-weight: 500;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  max-width: 320px;
}

.live-toast.show {
  transform: translateY(0);
  opacity: 1;
}

.live-toast.toast-success {
  border-left: 4px solid #28a745;
}

.live-toast.toast-error {
  border-left: 4px solid #dc3545;
}

/* Fade-in Animation */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fadeIn 0.3s ease-out forwards;
}

/* Empty State */
.empty-state {
  background: #f8f9fa;
  border-radius: 0 0 16px 16px;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .hero-section {
    padding: 1.25rem 0;
  }
  
  .hero-content {
    margin-bottom: 1rem;
  }
  
  .card-header {
    padding: 1rem;
  }
  
  .table-leaderboard thead th,
  .table-results thead th,
  .table-leaderboard tbody td,
  .table-results tbody td {
    padding: 0.75rem 1rem;
  }
  
  .sticky-sidebar {
    position: static;
    top: auto;
  }
  
  .live-toast {
    left: 16px;
    right: 16px;
    max-width: none;
  }
}

@media (max-width: 576px) {
  .table-results thead th:nth-child(3),
  .table-results tbody td:nth-child(3),
  .table-results thead th:nth-child(4),
  .table-results tbody td:nth-child(4) {
    display: none;
  }
  
  .rank-cell {
    width: 28px;
    height: 28px;
    font-size: 0.8rem;
  }
  
  .list-group-item {
    padding: 1rem;
  }
}

/* Print Styles */
@media print {
  .hero-section, .btn-back, .live-badge, .filter-card, .update-card {
    display: none !important;
  }
  
  .main-card, .sidebar-card {
    box-shadow: none !important;
    border: 1px solid #dee2e6 !important;
  }
}
</style>
{% endblock %}