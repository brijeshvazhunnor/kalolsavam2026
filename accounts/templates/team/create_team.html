{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="container-fluid py-4 college-dashboard">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card sidebar-card shadow border-0 h-100">
                <div class="gradient-header text-white p-4 text-center rounded-top">
                    <i class="fas fa-university fa-3x mb-2 text-white-50"></i>
                    <h5 class="fw-bold mb-1">{{ user.username }}</h5>
                    <p class="small opacity-75 mb-0">College Administrator</p>
                </div>

                <div class="p-3">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'college_dashboard' %}">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'register_student' %}">
                                <i class="fas fa-user-plus me-2"></i>Register Students
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'team_creation' %}">
                                <i class="fas fa-users me-2"></i>Create Teams
                            </a>
                        </li>
                    </ul>

                    <hr class="my-3">
                    <a class="nav-link logout-btn text-danger" href="{% url 'logout' %}">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-12">

            <!-- Page Header -->
            <div class="main-header mb-4 p-4">
                <div>
                    <h2 class="h4 fw-bold text-dark mb-1">
                        <i class="fas fa-users me-2 text-primary"></i>Create Team
                    </h2>
                    <p class="text-muted mb-0">Select category → event → students</p>
                </div>
            </div>

            <!-- Flash Messages -->
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-3">
                    <i class="fas fa-info-circle me-2"></i>{{ message }}
                    <button class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}

            <!-- Team Creation -->
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="fas fa-edit me-2"></i>Team Formation
                </div>

                <div class="card-body p-4">
                    <form method="POST" id="teamForm">
                        {% csrf_token %}

                        <!-- Category -->
                        <label class="form-label fw-semibold">Select Category *</label>
                        <select id="category-select" class="form-select form-select-lg mb-3" required>
                            <option value="">-- Select Category --</option>
                            {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>


                        <!-- Event -->
                        <label class="form-label fw-semibold">Select Event Item *</label>
                        <select name="item" id="item-select" class="form-select form-select-lg mb-4" required disabled>
                            <option value="">-- Select Category First --</option>
                            {% for item in items %}
                            <option value="{{ item.id }}" data-cat="{{ item.category }}" data-max="{{ item.max_participants }}">
                                {{ item.name }}
                            </option>
                            {% endfor %}
                        </select>

                        <div id="item-info"></div>

                        <!-- Students -->
                        <label class="form-label fw-semibold mt-3">Select Participants</label>
                        <div id="selection-counter" class="alert alert-secondary mb-3">
                            <i class="fas fa-info-circle me-2"></i>No students selected yet
                        </div>

                        <div class="student-selection p-3">
                            <div class="row">
                                {% for student in students %}
                                <div class="col-md-6 mb-2">
                                    <label class="form-check student-card p-2 rounded w-100">
                                        <input class="form-check-input student-checkbox" type="checkbox"
                                               name="students" value="{{ student.id }}">
                                        <span>
                                            <strong>{{ student.name }}</strong><br>
                                            <small class="text-muted">{{ student.department }} • Year {{ student.current_year }}</small>
                                        </span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-4" id="submitBtn">
                            <i class="fas fa-check-circle me-2"></i>Create Team
                        </button>
                    </form>
                </div>
            </div>

            <!-- List of existing teams -->
            <div class="card shadow border-0">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="fas fa-list me-2"></i>Teams Already Created
                </div>
                <div class="card-body p-0">
                    {% if teams %}
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Participants</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for t in teams %}
                            <tr>
                                <td>{{ t.item.name }}</td>
                                <td>{{ t.category }}</td>
                                <td>{{ t.students.count }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center text-muted py-4 mb-0">No teams created yet.</p>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/* CATEGORY → FILTER EVENT ITEMS */
document.getElementById("category-select").addEventListener("change", function () {
    let cat = this.value;
    let eventSelect = document.getElementById("item-select");

    eventSelect.disabled = (cat === "");
    eventSelect.value = "";

    document.querySelectorAll("#item-select option").forEach(o => {
        if (o.value === "") return;
        o.style.display = (o.dataset.cat === cat) ? "block" : "none";
    });

    document.getElementById("item-info").innerHTML = "";
});

/* SHOW MAX PARTICIPANTS */
document.getElementById("item-select").addEventListener("change", function () {
    let max = this.options[this.selectedIndex].dataset.max;
    document.getElementById("item-info").innerHTML =
        `<div class="alert alert-info mt-2">
            Maximum participants allowed: <strong>${max}</strong>
        </div>`;
});

/* SELECTION COUNTER */
let checkboxes = document.querySelectorAll('.student-checkbox');
let submitBtn = document.getElementById('submitBtn');

function updateCounter() {
    let selected = document.querySelectorAll(".student-checkbox:checked").length;
    let max = document.querySelector("#item-select")?.options[
        document.querySelector("#item-select").selectedIndex
    ]?.dataset.max || 0;

    let counter = document.getElementById("selection-counter");
    if (!max) {
        counter.className = "alert alert-secondary";
        counter.innerHTML = "<i class='fas fa-info-circle me-2'></i>Select event first";
        submitBtn.disabled = true;
        return;
    }
    counter.innerHTML = `<i class='fas fa-users me-2'></i><strong>${selected}</strong> / ${max} selected`;

    counter.className =
        selected > max ? "alert alert-danger" :
        selected == max ? "alert alert-success" : "alert alert-primary";

    submitBtn.disabled = (selected == 0 || selected > max);
}
checkboxes.forEach(c => c.addEventListener('change', updateCounter));
</script>

<style>
.student-card{border:1px solid #eee;cursor:pointer;transition:.2s}
.student-card:hover{background:#f5f8ff;border-color:#aac7ff}
.student-card input:checked + span{color:#0d6efd}
.main-header{background:#fff;border-left:4px solid #0d6efd;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.student-selection{border:2px solid #e9ecef;border-radius:10px;background:#fcfcfc}
.table td,.table th{padding:1rem}
</style>
{% endblock %}
