{% extends 'base.html' %}
{% load static %}

{% block title %}Team Creation | Kalolsavam 2026{% endblock %}

{% block extra_css %}
<style>
    /* Team Creation Specific Styles */
    
    .page-wrapper {
        background: linear-gradient(135deg, #f9f7f0 0%, #f0ede4 100%);
        min-height: calc(100vh - 180px);
        padding: 2rem 0;
    }
    
    /* Sidebar Styling */
    .sidebar-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 241, 233, 0.98) 100%);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--border-radius);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        height: 100%;
    }
    
    .gradient-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
        padding: 2rem 1.5rem;
        position: relative;
        overflow: hidden;
    }
    
    .gradient-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.1) 100%);
    }
    
    .gradient-header i {
        font-size: 3.5rem;
        color: var(--accent-gold);
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.1);
        width: 90px;
        height: 90px;
        line-height: 90px;
        border-radius: 50%;
        border: 3px solid rgba(212, 175, 55, 0.3);
    }
    
    .gradient-header h5 {
        font-family: 'Playfair Display', serif;
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
        color: white;
    }
    
    .gradient-header .small {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
    }
    
    /* Sidebar Navigation */
    .nav-pills {
        padding: 1.5rem 1rem;
    }
    
    .nav-link {
        border-radius: 10px;
        padding: 1rem 1.2rem !important;
        margin-bottom: 0.8rem;
        color: var(--text-dark) !important;
        background: transparent;
        border: 1px solid rgba(212, 175, 55, 0.1);
        transition: var(--transition);
        font-weight: 500;
    }
    
    .nav-link:hover {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(193, 154, 107, 0.1) 100%);
        color: var(--primary-dark) !important;
        border-color: var(--accent-gold);
        transform: translateX(5px);
    }
    
    .nav-link.active {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
        color: white !important;
        border-color: var(--accent-gold);
        box-shadow: 0 5px 15px rgba(26, 31, 43, 0.2);
    }
    
    .nav-link i {
        width: 25px;
        text-align: center;
        margin-right: 10px;
        font-size: 1.1rem;
    }
    
    .nav-link.text-danger {
        color: var(--danger) !important;
    }
    
    .nav-link.text-danger:hover {
        background: rgba(220, 53, 69, 0.1);
    }
    
    /* Main Header */
    .main-header {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 241, 233, 0.98) 100%);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--border-radius);
        padding: 1.8rem 2rem;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .main-header h4 {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
    }
    
    .main-header p {
        color: var(--text-light);
        margin: 0;
    }
    
    .main-header i {
        color: var(--accent-gold);
        background: rgba(212, 175, 55, 0.1);
        padding: 10px;
        border-radius: 50%;
    }
    
    /* Category Limits Card */
    .category-limits-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 241, 233, 0.98) 100%);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }
    
    .category-limits-card .card-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
        color: white;
        padding: 1.5rem 2rem;
        border: none;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    }
    
    .category-pill {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(245, 241, 233, 0.9) 100%);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        height: 100%;
        transition: var(--transition);
    }
    
    .category-pill:hover {
        border-color: var(--accent-gold);
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    }
    
    .category-pill.border-warning {
        border-left: 4px solid var(--accent-gold);
    }
    
    .progress {
        height: 8px;
        background: rgba(212, 175, 55, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, var(--accent-gold), var(--accent-bronze));
        border-radius: 4px;
    }
    
    /* Team Creation Card */
    .team-creation-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 241, 233, 0.98) 100%);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .team-creation-card .card-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
        color: white;
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        font-size: 1.2rem;
        padding: 1.5rem 2rem;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .team-creation-card .card-header .badge {
        background: var(--accent-gold);
        color: var(--primary-dark);
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 20px;
    }
    
    /* Form Styling */
    .form-label {
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .form-control, .form-select {
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 8px;
        padding: 0.8rem 1rem;
        background: rgba(255, 255, 255, 0.9);
        transition: var(--transition);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--accent-gold);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        background: white;
    }
    
    .fancy-select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23d4af37' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 16px;
        padding-right: 2.5rem;
    }
    
    /* Student Search */
    #student-search {
        border-radius: 20px;
        padding: 0.6rem 1rem;
        border: 1px solid rgba(212, 175, 55, 0.3);
        background: white;
    }
    
    #student-search:focus {
        border-color: var(--accent-gold);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }
    
    /* Selection Counter */
    #selection-counter {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(193, 154, 107, 0.1) 100%);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 10px;
        padding: 1rem 1.5rem;
        margin: 1.5rem 0;
    }
    
    #selection-counter.alert-secondary {
        background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(108, 117, 125, 0.05) 100%);
        border-color: rgba(108, 117, 125, 0.3);
    }
    
    #selection-counter.alert-primary {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.05) 100%);
        border-color: rgba(13, 110, 253, 0.3);
    }
    
    #selection-counter.alert-success {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.1) 0%, rgba(25, 135, 84, 0.05) 100%);
        border-color: rgba(25, 135, 84, 0.3);
    }
    
    #selection-counter.alert-danger {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%);
        border-color: rgba(220, 53, 69, 0.3);
    }
    
    /* Student List */
    .student-list {
        border: 2px solid rgba(212, 175, 55, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        max-height: 380px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.5);
    }
    
    .student-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .student-list::-webkit-scrollbar-track {
        background: rgba(212, 175, 55, 0.1);
        border-radius: 3px;
    }
    
    .student-list::-webkit-scrollbar-thumb {
        background: var(--accent-gold);
        border-radius: 3px;
    }
    
    .student-card {
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: var(--transition);
        background: white;
        margin-bottom: 0.5rem;
    }
    
    .student-card:hover {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(193, 154, 107, 0.05) 100%);
        border-color: var(--accent-gold);
        transform: translateX(5px);
    }
    
    .student-card input:checked + span {
        color: var(--primary-dark);
    }
    
    .student-card input:checked + span strong {
        color: var(--accent-gold);
    }
    
    /* Submit Button */
    #submitBtn {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
        border: none;
        padding: 1rem 2rem;
        font-weight: 600;
        border-radius: 10px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 2rem;
    }
    
    #submitBtn:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-bronze) 100%);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(212, 175, 55, 0.3);
    }
    
    #submitBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Teams List Card */
    .teams-list-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 241, 233, 0.98) 100%);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .teams-list-card .card-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        font-size: 1.2rem;
        padding: 1.5rem 2rem;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* Table Styling */
    .pretty-table {
        margin: 0;
    }
    
    .pretty-table thead {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(193, 154, 107, 0.1) 100%);
    }
    
    .pretty-table th {
        font-weight: 600;
        color: var(--primary-dark);
        padding: 1rem 1.5rem;
        border-bottom: 2px solid rgba(212, 175, 55, 0.3);
    }
    
    .pretty-table td {
        padding: 1rem 1.5rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(212, 175, 55, 0.1);
    }
    
    .pretty-table tbody tr {
        transition: var(--transition);
    }
    
    .pretty-table tbody tr:hover {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(193, 154, 107, 0.05) 100%);
    }
    
    /* Modal Styling */
    .modal-content {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 241, 233, 0.98) 100%);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: var(--border-radius);
    }
    
    .modal-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
        color: white;
        border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .modal-title {
        font-family: 'Playfair Display', serif;
        font-weight: 600;
    }
    
    /* Action Buttons */
    .btn-outline-primary {
        border: 2px solid var(--primary-dark);
        color: var(--primary-dark);
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: var(--transition);
    }
    
    .btn-outline-primary:hover {
        background: var(--primary-dark);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(26, 31, 43, 0.1);
    }
    
    .btn-outline-danger {
        border: 2px solid var(--danger);
        color: var(--danger);
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: var(--transition);
    }
    
    .btn-outline-danger:hover {
        background: var(--danger);
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-outline-secondary {
        border: 2px solid var(--text-light);
        color: var(--text-light);
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: var(--transition);
    }
    
    .btn-outline-secondary:hover {
        background: var(--text-light);
        color: white;
    }
    
    /* Empty State */
    .empty-state {
        padding: 3rem 2rem;
        text-align: center;
        color: var(--text-light);
    }
    
    .empty-state i {
        font-size: 3rem;
        color: rgba(212, 175, 55, 0.3);
        margin-bottom: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .sidebar-card {
            margin-bottom: 2rem;
        }
        
        .main-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .main-header .d-flex {
            width: 100%;
            justify-content: flex-start;
        }
    }
    
    @media (max-width: 768px) {
        .page-wrapper {
            padding: 1rem 0;
        }
        
        .gradient-header {
            padding: 1.5rem;
        }
        
        .gradient-header i {
            width: 70px;
            height: 70px;
            line-height: 70px;
            font-size: 2.5rem;
        }
        
        .nav-link {
            padding: 0.8rem 1rem !important;
        }
        
        .student-list {
            max-height: 300px;
        }
    }
</style>
{% endblock %}

{% block page_title_content %}
    Team Creation
{% endblock %}

{% block content %}

<div class="container-fluid py-4 page-wrapper">
    <div class="row">

        <!-- SIDEBAR -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="sidebar-card">
                <div class="gradient-header text-center">
                    <i class="fas fa-university"></i>
                    <h5>{{ user.username }}</h5>
                    <p class="small opacity-75">College Administrator</p>
                </div>
                <div class="nav-container">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'register_student' %}">
                                <i class="fas fa-user-plus"></i>Register Students
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'team_creation' %}">
                                <i class="fas fa-users"></i>Create Teams
                            </a>
                        </li>
                    </ul>
                    <hr class="my-3">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-danger" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-lg-9 col-md-8">

            <!-- PAGE HEADER -->
            <div class="main-header">
                <div>
                    <h4 class="mb-1">
                        <i class="fas fa-users me-2"></i>Create Your Team
                    </h4>
                    <p class="mb-0 text-muted">
                        Select category → event → participants
                    </p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <a href="{% url 'register_student' %}" class="btn btn-outline-primary">
                        <i class="fas fa-user-plus me-2"></i>Register Students
                    </a>
                </div>
            </div>

            <!-- CATEGORY LIMIT SUMMARY -->
            {% if category_limits %}
            <div class="category-limits-card">
                <div class="card-header">
                    <div>
                        <i class="fas fa-chart-pie me-2"></i>Category Usage Overview
                    </div>
                    <small class="opacity-75">Per-college team limits</small>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for category in category_limits %}
                        <div class="col-md-6 col-xl-4">
                            <div class="category-pill">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold text-capitalize">{{ category.label }}</span>
                                    <span class="badge" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(193, 154, 107, 0.1)); color: var(--primary-dark);">
                                        {{ category.used }}/{{ category.limit }}
                                    </span>
                                </div>
                                <div class="progress mb-2">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ category.percent|floatformat:0 }}%;"></div>
                                </div>
                                <small class="text-muted">
                                    {% if category.remaining > 0 %}
                                        {{ category.remaining }} team{{ category.remaining|pluralize }} remaining
                                    {% else %}
                                        <span style="color: var(--danger);">Limit reached</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Natakam info -->
                        <div class="col-md-6 col-xl-4">
                            <div class="category-pill border-warning">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold" style="color: var(--accent-gold);">
                                        Natakam Limit
                                    </span>
                                    <span class="badge" style="background: var(--accent-gold); color: var(--primary-dark);">
                                        {{ natakam_count }}/{{ max_natakam }}
                                    </span>
                                </div>
                                <small class="text-muted d-block">
                                    Across:
                                    {% for item in NATAKAM_ITEMS %}
                                        <span class="badge me-1 mb-1" style="background: rgba(212, 175, 55, 0.1); color: var(--primary-dark); border: 1px solid rgba(212, 175, 55, 0.3);">
                                            {{ item }}
                                        </span>
                                    {% endfor %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- TEAM CREATION CARD -->
            <div class="team-creation-card">
                <div class="card-header">
                    <span>
                        <i class="fas fa-edit me-2"></i>Team Formation
                    </span>
                    <span class="badge">Step 1 of 2</span>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="teamForm" autocomplete="off">
                        {% csrf_token %}

                        <!-- CATEGORY -->
                        <div class="mb-4">
                            <label class="form-label">Select Category *</label>
                            <select id="category-select" class="form-select fancy-select" required>
                                <option value="">-- Select Category --</option>
                                {% for category in categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text text-muted">Filtered event list will appear after selecting category.</div>
                        </div>

                        <!-- EVENT ITEM -->
                        <div class="mb-4">
                            <label class="form-label">Select Event Item *</label>
                            <select id="item-select" name="item" class="form-select fancy-select" required disabled>
                                <option value="">-- Select Category First --</option>
                                {% for item in items %}
                                    <option value="{{ item.id }}"
                                            data-cat="{{ item.category }}"
                                            data-max="{{ item.max_participants }}">
                                        {{ item.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div id="item-info" class="mt-2"></div>
                        </div>

                        <!-- STUDENT SEARCH -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                                <label class="form-label mb-0">Select Participants</label>
                                <input type="text" id="student-search" class="form-control form-control-sm"
                                       style="max-width: 260px;" placeholder="Search by name or department...">
                            </div>
                        </div>

                        <!-- SELECTION COUNTER -->
                        <div id="selection-counter" class="alert alert-secondary">
                            <i class="fas fa-info-circle me-2"></i>
                            No students selected
                        </div>

                        <!-- STUDENT LIST -->
                        <div class="student-list">
                            <div class="row" id="student-list-wrapper">
                                {% for student in students %}
                                <div class="col-md-6 mb-2 student-wrapper">
                                    <label class="form-check student-card"
                                           data-name="{{ student.name|lower }} {{ student.department|lower }}">
                                        <input class="form-check-input student-checkbox" type="checkbox"
                                               name="students" value="{{ student.id }}">
                                        <span>
                                            <strong>{{ student.name }}</strong><br>
                                            <small class="text-muted">
                                                {{ student.department }} • Year {{ student.current_year }}
                                            </small>
                                        </span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <button type="submit" id="submitBtn" class="btn btn-primary w-100">
                            <i class="fas fa-check-circle me-2"></i>Create Team
                        </button>
                    </form>
                </div>
            </div>

            <!-- TEAM LIST CARD -->
            <div class="teams-list-card">
                <div class="card-header">
                    <span><i class="fas fa-list me-2"></i>Your Created Teams</span>
                    <small class="opacity-75">Total: {{ teams|length }}</small>
                </div>
                <div class="card-body p-0">
                    {% if teams %}
                    <div class="table-responsive">
                        <table class="table pretty-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Category</th>
                                    <th>Participants</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in teams %}
                                <tr>
                                    <td>
                                        <span class="fw-semibold">{{ team.item.name }}</span><br>
                                        <small class="text-muted">{{ team.item.item_type|capfirst }}</small>
                                    </td>
                                    <td>{{ team.category }}</td>
                                    <td>{{ team.students.count }}</td>
                                    <td class="text-end">
                                        <button class="btn btn-outline-primary btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editTeamModal{{ team.id }}">
                                            <i class="fas fa-pencil-alt me-1"></i>Edit Team
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h6 class="mb-2">No Teams Created Yet</h6>
                            <p class="text-muted mb-0">Create your first team using the form above</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<!-- EDIT TEAM MODALS -->
{% if teams %}
    {% for team in teams %}
    <div class="modal fade" id="editTeamModal{{ team.id }}" tabindex="-1" aria-hidden="true"
         data-max="{{ team.item.max_participants }}">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <form method="POST" action="{% url 'edit_team' team.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">
                            Edit Team – {{ team.item.name }} (Max: {{ team.item.max_participants }})
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="small text-muted mb-3">
                            Category: <strong>{{ team.category }}</strong> •
                            Type: <strong>{{ team.item.item_type|capfirst }}</strong>
                        </p>

                        <div class="alert alert-secondary mb-3 modal-counter">
                            <i class="fas fa-info-circle me-2"></i>
                            <span class="modal-selection-info">Updating…</span>
                        </div>

                        <div class="row">
                            {% for student in students %}
                            <div class="col-md-6 mb-2">
                                <label class="form-check student-card">
                                    <input class="form-check-input modal-student-checkbox"
                                           type="checkbox"
                                           name="edit_students"
                                           value="{{ student.id }}"
                                           {% if student in team.students.all %}checked{% endif %}>
                                    <span>
                                        <strong>{{ student.name }}</strong><br>
                                        <small class="text-muted">
                                            {{ student.department }} • Year {{ student.current_year }}
                                        </small>
                                    </span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <button type="button"
                                class="btn btn-outline-danger"
                                onclick="confirmDeleteTeam('{{ team.id }}')">
                            <i class="fas fa-trash-alt me-1"></i> Delete Team
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary modal-save-btn">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// ----- existing teams (for quick warning when selecting an item) -----
const existingTeams = new Set(
    JSON.parse(`[{% for id in existing_item_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}]`)
);

function confirmDeleteTeam(teamId) {
    if (confirm("Are you sure you want to delete this team? This action cannot be undone.")) {
        window.location.href = `/team/delete/${teamId}/`;
    }
}

document.addEventListener("DOMContentLoaded", function () {
    const categorySelect    = document.getElementById("category-select");
    const itemSelect        = document.getElementById("item-select");
    const itemInfo          = document.getElementById("item-info");
    const searchInput       = document.getElementById("student-search");
    const selectionCounter  = document.getElementById("selection-counter");
    const submitBtn         = document.getElementById("submitBtn");
    const teamForm          = document.getElementById("teamForm");

    // ---- CATEGORY FILTER ----
    categorySelect.addEventListener("change", function () {
        const cat = this.value;
        itemSelect.disabled = (cat === "");
        itemSelect.value = "";
        itemInfo.innerHTML = "";
        updateCounter();

        const options = itemSelect.querySelectorAll("option");
        options.forEach(opt => {
            if (!opt.value) return; // skip placeholder
            opt.style.display = (opt.dataset.cat === cat) ? "block" : "none";
        });
    });

    // ---- ITEM CHANGE (MAX + ALREADY TEAM) ----
    itemSelect.addEventListener("change", function () {
        const selectedOpt = this.options[this.selectedIndex];
        if (!selectedOpt || !selectedOpt.value) {
            itemInfo.innerHTML = "";
            updateCounter();
            return;
        }

        const max = selectedOpt.dataset.max;
        const itemId = parseInt(selectedOpt.value);
        let warnHtml = "";

        if (existingTeams.has(itemId)) {
            warnHtml = `
                <div class="alert alert-warning mb-2" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05)); border: 1px solid rgba(255, 193, 7, 0.3);">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    You already have a team for this item. You can edit it in the "Your Created Teams" section below.
                </div>
            `;
        }

        itemInfo.innerHTML = `
            ${warnHtml}
            <div class="alert alert-info mb-0" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 110, 253, 0.05)); border: 1px solid rgba(13, 110, 253, 0.3);">
                <i class="fas fa-users me-2"></i>
                Maximum participants allowed: <strong>${max}</strong>
            </div>
        `;
        updateCounter();
    });

    // ---- SEARCH AS YOU TYPE ----
    if (searchInput) {
        searchInput.addEventListener("input", function () {
            const q = this.value.toLowerCase().trim();
            document.querySelectorAll(".student-wrapper").forEach(wrapper => {
                const nameData = wrapper.querySelector(".student-card").dataset.name;
                if (!q || nameData.includes(q)) {
                    wrapper.style.display = "";
                } else {
                    wrapper.style.display = "none";
                }
            });
        });
    }

    // ---- SELECTION COUNTER FOR CREATE FORM ----
    function updateCounter() {
        const selected = document.querySelectorAll(".student-checkbox:checked").length;
        const selectedOpt = itemSelect.options[itemSelect.selectedIndex];
        const max = selectedOpt && selectedOpt.dataset.max ? parseInt(selectedOpt.dataset.max) : 0;

        if (!max) {
            selectionCounter.className = "alert alert-secondary";
            selectionCounter.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                Select a category and event item first
            `;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Select Item First';
            return;
        }

        selectionCounter.innerHTML = `
            <i class="fas fa-users me-2"></i>
            Selected: <strong>${selected}</strong> / ${max}
        `;
        
        if (selected === 0) {
            selectionCounter.className = "alert alert-secondary";
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-user-slash me-2"></i>Select Students';
        } else if (selected > max) {
            selectionCounter.className = "alert alert-danger";
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Too Many Students';
        } else if (selected === max) {
            selectionCounter.className = "alert alert-success";
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Create Team';
        } else {
            selectionCounter.className = "alert alert-primary";
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Create Team';
        }
    }

    document.querySelectorAll(".student-checkbox").forEach(cb =>
        cb.addEventListener("change", updateCounter)
    );
    updateCounter();

    // ---- FORM SUBMIT VALIDATION (BACKUP) ----
    teamForm.addEventListener("submit", function (e) {
        const itemValue = itemSelect.value;
        const selected = document.querySelectorAll(".student-checkbox:checked").length;
        const selectedOpt = itemSelect.options[itemSelect.selectedIndex];
        const max = selectedOpt && selectedOpt.dataset.max ? parseInt(selectedOpt.dataset.max) : 0;

        if (!itemValue) {
            e.preventDefault();
            alert("Please select an event item.");
            itemSelect.focus();
            return false;
        }
        if (selected === 0) {
            e.preventDefault();
            alert("Please select at least one student.");
            return false;
        }
        if (max && selected > max) {
            e.preventDefault();
            alert(`You can select at most ${max} students for this item.`);
            return false;
        }
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Team...';
    });

    // ---- EDIT TEAM MODALS ----
    document.querySelectorAll(".modal").forEach(modal => {
        const max = parseInt(modal.dataset.max || "0");
        const checkboxes = modal.querySelectorAll(".modal-student-checkbox");
        const counterBox = modal.querySelector(".modal-counter");
        const infoSpan = modal.querySelector(".modal-selection-info");
        const saveBtn = modal.querySelector(".modal-save-btn");

        function updateModalCounter() {
            const selected = modal.querySelectorAll(".modal-student-checkbox:checked").length;

            infoSpan.textContent = `Selected ${selected} / ${max}`;
            if (selected === 0) {
                counterBox.className = "alert alert-secondary modal-counter";
                saveBtn.disabled = true;
            } else if (selected > max) {
                counterBox.className = "alert alert-danger modal-counter";
                saveBtn.disabled = true;
            } else if (selected === max) {
                counterBox.className = "alert alert-success modal-counter";
                saveBtn.disabled = false;
            } else {
                counterBox.className = "alert alert-primary modal-counter";
                saveBtn.disabled = false;
            }
        }

        checkboxes.forEach(cb => cb.addEventListener("change", updateModalCounter));
        updateModalCounter();
    });

    // ---- ANIMATE STUDENT CARDS ON HOVER ----
    document.querySelectorAll('.student-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(5px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0) scale(1)';
        });
    });
});
</script>
{% endblock %}