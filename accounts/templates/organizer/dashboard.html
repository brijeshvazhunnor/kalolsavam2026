{% extends "base.html" %}
{% block title %}Organizer Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-4">Organizer Dashboard</h3>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card shadow-sm p-3 h-100">
        <h6 class="mb-1">Items</h6>
        <div class="display-6 fw-bold">{{ total_items }}</div>
        <p class="text-muted">Total event items</p>
        <a href="{% url 'organizer_items' %}" class="btn btn-primary btn-sm mt-2">Manage Items</a>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm p-3 h-100">
        <h6 class="mb-1">Teams</h6>
        <div class="display-6 fw-bold">{{ total_teams }}</div>
        <p class="text-muted">Registered teams</p>
        <a href="{% url 'organizer_items' %}" class="btn btn-outline-primary btn-sm mt-2">Teams & Results</a>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm p-3 h-100">
        <h6 class="mb-1">Results</h6>
        <div class="display-6 fw-bold">{{ total_results }}</div>
        <p class="text-muted">Published results</p>
        <a href="{% url 'organizer_items' %}" class="btn btn-outline-secondary btn-sm mt-2">Manage Results</a>
      </div>
    </div>
  </div>

  <div class="card mt-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Live College Rankings</strong>
      <small class="text-muted">Auto refresh</small>
    </div>

    <ul class="list-group list-group-flush" id="rankingList">
      <li class="list-group-item text-center text-muted">Loading...</li>
    </ul>
  </div>
</div>

{% block extra_js %}
<script>
let lastOrder = [];
function loadRankings() {
    fetch("{% url 'college_ranking_live' %}")
    .then(r => r.json())
    .then(data => {
        const list = document.getElementById("rankingList");
        list.innerHTML = "";
        if (!data.rankings || data.rankings.length === 0) {
            list.innerHTML = '<li class="list-group-item text-center text-muted">No published results</li>';
            lastOrder = [];
            return;
        }

        const newOrder = data.rankings.map(x => x.college);

        data.rankings.forEach((row, idx) => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            let trend = "";
            const prev = lastOrder.indexOf(row.college);
            if (prev === -1) trend = "";
            else if (prev > idx) trend = '<span class="text-success ms-2"><i class="fas fa-arrow-up"></i></span>';
            else if (prev < idx) trend = '<span class="text-danger ms-2"><i class="fas fa-arrow-down"></i></span>';
            li.innerHTML = `<div><strong>${idx+1}. ${row.college}</strong> ${trend}<div class="text-muted small">${row.total_points} pts</div></div>
                            <span class="badge bg-success">${row.total_points} pts</span>`;
            list.appendChild(li);
        });

        lastOrder = newOrder;
    })
    .catch(e => {
        console.error(e);
    });
}
document.addEventListener("DOMContentLoaded", () => {
    loadRankings();
    setInterval(loadRankings, 5000);
});
</script>
{% endblock %}
{% endblock %}
