{% extends "base.html" %}
{% block title %}Manage Results{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Manage Results</h3>
    <div>
      <a class="btn btn-sm btn-outline-secondary me-2" href="{% url 'export_results_pdf' %}"><i class="fas fa-file-pdf"></i> PDF</a>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'export_results_excel' %}"><i class="fas fa-file-excel"></i> Excel</a>
    </div>
  </div>

  <form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if c == selected_category %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6 position-relative">
      <input type="text" name="q" id="itemSearch" class="form-control" value="{{ q }}" placeholder="Type item name..." autocomplete="off">
      <ul id="suggestionBox" class="list-group position-absolute w-100" style="display:none; z-index: 1000;"></ul>
    </div>

    <div class="col-md-3">
      <button class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Category</th>
            <th>Item</th>
            <th>Teams</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td class="text-muted">{{ item.category }}</td>
            <td class="fw-semibold">{{ item.name }}</td>
            <td><span class="badge bg-info text-dark">{{ item.team_set.count }}</span></td>
            <td>
              {% if item.results.filter(is_deleted=False).exists %}
                <span class="badge bg-success">Results Added</span>
              {% else %}
                <span class="badge bg-secondary">No Results</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if item.results.filter(is_deleted=False).exists %}
                <a class="btn btn-sm btn-outline-success" href="{% url 'view_results' item.id %}"><i class="fas fa-eye"></i></a>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'add_results' item.id %}"><i class="fas fa-edit"></i></a>
                <a class="btn btn-sm btn-danger" href="{% url 'delete_item_results' item.id %}" onclick="return confirm('Delete all results for this item?');"><i class="fas fa-trash"></i></a>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'undo_delete_results' item.id %}">Undo</a>
              {% else %}
                <a class="btn btn-sm btn-primary" href="{% url 'add_results' item.id %}"><i class="fas fa-plus"></i> Add</a>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center py-4 text-muted">No items found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("itemSearch");
    const suggestionBox = document.getElementById("suggestionBox");
    const items = [
        {% for it in all_items %}
        {name: "{{ it.name|escapejs }}", id: "{{ it.id }}", category: "{{ it.category|escapejs }}"},
        {% endfor %}
    ];

    searchInput.addEventListener("input", () => {
        const q = searchInput.value.trim().toLowerCase();
        suggestionBox.innerHTML = "";
        if (!q) { suggestionBox.style.display = "none"; return; }
        const filtered = items.filter(i => i.name.toLowerCase().includes(q)).slice(0, 6);
        filtered.forEach(it => {
            const li = document.createElement("li");
            li.className = "list-group-item list-group-item-action";
            li.innerHTML = `<strong>${it.name}</strong><br><small class="text-muted">${it.category}</small>`;
            li.onclick = () => {
                searchInput.value = it.name;
                suggestionBox.style.display = "none";
            };
            suggestionBox.appendChild(li);
        });
        suggestionBox.style.display = filtered.length ? "block" : "none";
    });

    document.addEventListener("click", (e) => {
        if (!searchInput.contains(e.target)) suggestionBox.style.display = "none";
    });
});
</script>
{% endblock %}
